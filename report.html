<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Reports - Dr. Labs</title>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: linear-gradient(to bottom right, lightblue, lightgreen);
        padding: 20px;
    }
    h1 {
        text-align: center;
        margin-bottom: 20px;
    }
    .filter-section {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
        justify-content: center;
    }
    input, select, button {
        padding: 6px;
        border-radius: 5px;
        border: 1px solid #ccc;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    th, td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
    }
    th {
        background: #007BFF;
        color: white;
    }
    .status-confirmed { background: lightgreen; }
    .status-cancelled { background: lightcoral; }
    .status-report { background: lightblue; }
</style>
</head>
<body>

<h1>Reports</h1>

<div class="filter-section">
    <input type="date" id="fromDate">
    <input type="date" id="toDate">
    <select id="cityFilter"><option value="">City</option></select>
    <select id="techFilter"><option value="">Technician</option></select>
    <select id="agentFilter"><option value="">Agent</option></select>
    <select id="statusFilter">
        <option value="">Status</option>
        <option value="Confirmed">Confirmed</option>
        <option value="Cancelled">Cancelled</option>
        <option value="Report Generated">Report Generated</option>
    </select>
    <input type="text" id="phoneFilter" placeholder="Phone">
    <button onclick="loadReport()">Filter</button>
    <button onclick="downloadCSV()">Download CSV</button>
</div>

<table>
    <thead>
        <tr>
            <th>Customer Number</th>
            <th>Customer Name</th>
            <th>Location</th>
            <th>Preferred Date</th>
            <th>Preferred Time</th>
            <th>Agent</th>
            <th>Technician</th>
            <th>Status</th>
            <th>Total Cost</th>
        </tr>
    </thead>
    <tbody id="reportTable"></tbody>
</table>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxBJHuzAe1EN6npzN-1W6Uc-azhf8-qkm3D6swOqeY3tiNgvXe9wBnA9eI4mPYntS26kw/exec";

document.addEventListener("DOMContentLoaded", () => {
    loadDropdown("cityFilter", "getCities");
    loadDropdown("techFilter", "getTechnicians");
    loadDropdown("agentFilter", "getAgents");
});

function loadDropdown(id, action) {
    fetch(`${WEB_APP_URL}?action=${action}`)
        .then(r => r.json())
        .then(data => {
            const sel = document.getElementById(id);
            data.forEach(item => {
                const opt = document.createElement("option");
                opt.value = item.name || item;
                opt.textContent = item.name || item;
                sel.appendChild(opt);
            });
        });
}

function loadReport() {
    const params = new URLSearchParams({
        action: "getReport",
        fromDate: document.getElementById("fromDate").value,
        toDate: document.getElementById("toDate").value,
        city: document.getElementById("cityFilter").value,
        technician: document.getElementById("techFilter").value,
        agent: document.getElementById("agentFilter").value,
        status: document.getElementById("statusFilter").value,
        phone: document.getElementById("phoneFilter").value
    });

    fetch(`${WEB_APP_URL}?${params}`)
        .then(r => r.json())
        .then(data => {
            const tbody = document.getElementById("reportTable");
            tbody.innerHTML = "";
            if (!data.length) {
                tbody.innerHTML = `<tr><td colspan="9">No results</td></tr>`;
                return;
            }
            data.forEach(row => {
                const tr = document.createElement("tr");
                tr.className = row.status === "Cancelled" ? "status-cancelled" :
                               row.status === "Report Generated" ? "status-report" :
                               "status-confirmed";
                tr.innerHTML = `
                    <td>${row.customerNumber}</td>
                    <td>${row.customerName}</td>
                    <td>${row.location}</td>
                    <td>${row.prefDate}</td>
                    <td>${row.prefTime}</td>
                    <td>${row.agentName}</td>
                    <td>${row.technician}</td>
                    <td>${row.status}</td>
                    <td>${row.totalCost}</td>
                `;
                tbody.appendChild(tr);
            });
        });
}

function downloadCSV() {
    let csv = [];
    const rows = document.querySelectorAll("table tr");
    rows.forEach(row => {
        const cols = row.querySelectorAll("td, th");
        const vals = Array.from(cols).map(col => `"${col.innerText}"`);
        csv.push(vals.join(","));
    });
    const blob = new Blob([csv.join("\n")], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "report.csv";
    a.click();
}
</script>
</body>
</html>
