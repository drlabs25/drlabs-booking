<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Reports - Dr. Labs</title>
<style>
 body{font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,lightblue,lightgreen);margin:0;padding:18px}
 .filter{background:#fff;padding:12px;border-radius:8px;max-width:1100px;margin:12px auto}
 input,select,button{padding:8px;margin:6px;border-radius:6px;border:1px solid #ccc}
 table{width:100%;border-collapse:collapse;margin-top:12px;background:#fff}
 th,td{padding:8px;border:1px solid #eee;text-align:left}
 th{background:#007bff;color:#fff}
</style>
</head>
<body>
  <div style="max-width:1100px;margin:0 auto">
    <h2>Booking Reports</h2>
    <div class="filter">
      <input type="date" id="startDate">
      <input type="date" id="endDate">
      <input id="city" placeholder="City">
      <input id="technician" placeholder="Technician">
      <input id="agent" placeholder="Agent">
      <select id="status"><option value="">All</option><option>Confirmed</option><option>Cancelled</option><option>Report Generated</option></select>
      <input id="phone" placeholder="Phone">
      <button onclick="loadReports()">Filter</button>
      <button onclick="downloadCSV()">Download CSV</button>
      <button onclick="location.href='index.html'">Back</button>
    </div>

    <div id="reportDiv"></div>
  </div>

<script>
const WEB_APP = 'https://script.google.com/macros/s/AKfycbxP3_J7NBRfkR82U_zqY102D1mhVvXbTXTvW-2L785h4_G4ac61u-SPfx7eZcT6RzKGeQ/exec';

function loadReports(){
  const params = {
    action: 'getReports',
    startDate: document.getElementById('startDate').value || '',
    endDate: document.getElementById('endDate').value || '',
    city: document.getElementById('city').value.trim(),
    technician: document.getElementById('technician').value.trim(),
    agent: document.getElementById('agent').value.trim(),
    status: document.getElementById('status').value,
    phone: document.getElementById('phone').value.trim()
  };
  fetch(`${WEB_APP}?${new URLSearchParams(params)}`).then(r=>r.json()).then(j=>{
    if(!j.success) return alert('No data');
    render(j.reports || []);
  }).catch(e=>{ console.error(e); alert('Error fetching'); });
}

function render(rows){
  if(!rows || !rows.length){ document.getElementById('reportDiv').innerHTML = '<div style="background:#fff;padding:12px;border-radius:8px">No results</div>'; return; }
  let html = '<table><thead><tr><th>BookingID</th><th>Phone</th><th>Name</th><th>Location</th><th>Date</th><th>Time</th><th>Agent</th><th>Technician</th><th>Status</th><th>FinalAmount</th></tr></thead><tbody>';
  rows.forEach(r => {
    html += `<tr><td>${r.bookingId}</td><td>${r.phone}</td><td>${r.name}</td><td>${r.location}</td><td>${r.prefDate}</td><td>${r.prefTime}</td><td>${r.agent}</td><td>${r.technician}</td><td>${r.status}</td><td>${r.finalAmount}</td></tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('reportDiv').innerHTML = html;
}

function downloadCSV(){
  const table = document.querySelector('#reportDiv table');
  if(!table) return alert('No data');
  const rows = Array.from(table.querySelectorAll('tr'));
  const csv = rows.map(r => {
    const cols = Array.from(r.querySelectorAll('th,td')).map(c => `"${c.innerText.replace(/"/g,'""')}"`);
    return cols.join(',');
  }).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'report.csv'; a.click();
}
</script>
</body>
</html>
