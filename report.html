<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Reports - Dr. Labs</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,lightblue,lightgreen);padding:18px;margin:0}
  .filter{background:#fff;padding:12px;border-radius:8px;max-width:1100px;margin:12px auto}
  input,select,button{padding:8px;margin:6px;border-radius:6px;border:1px solid #ccc}
  table{width:100%;border-collapse:collapse;margin-top:12px;background:#fff}
  th,td{padding:8px;border:1px solid #eee;text-align:left}
  th{background:#007bff;color:#fff}
</style>
</head>
<body>
  <div style="max-width:1100px;margin:0 auto">
    <h2>Booking Reports</h2>
    <div class="filter">
      <input type="date" id="startDate">
      <input type="date" id="endDate">
      <input id="city" placeholder="City">
      <input id="technician" placeholder="Technician">
      <input id="agent" placeholder="Agent">
      <select id="status"><option value="">All</option><option>Confirmed</option><option>Cancelled</option><option>Report Generated</option></select>
      <input id="phone" placeholder="Phone">
      <button onclick="loadReports()">Filter</button>
      <button onclick="downloadCSV()">Download CSV</button>
      <button onclick="location.href='index.html'">Back</button>
    </div>

    <div id="reportDiv"></div>
  </div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyKsG28Vso10fvXim3w9aAEnOwS5GO3IIoxSyUSOZyrG4U1DcDbyfUraYhTPzleNJrTgA/exec';

function loadReports(){
  const params = {
    action: 'getReports',
    startDate: document.getElementById('startDate').value || '',
    endDate: document.getElementById('endDate').value || '',
    city: document.getElementById('city').value.trim(),
    technician: document.getElementById('technician').value.trim(),
    agent: document.getElementById('agent').value.trim(),
    status: document.getElementById('status').value,
    phone: document.getElementById('phone').value.trim()
  };
  fetch(`${WEB_APP_URL}?${new URLSearchParams(params)}`).then(r=>r.json()).then(data=>{
    renderTable(data || []);
  }).catch(err=>{ console.error(err); alert('Failed to fetch reports'); });
}

function renderTable(rows){
  if(!rows || rows.length===0){ document.getElementById('reportDiv').innerHTML = '<div style="background:#fff;padding:12px;border-radius:8px">No results</div>'; return; }
  let html = '<table><thead><tr><th>Phone</th><th>Name</th><th>Location</th><th>Date</th><th>Time</th><th>Agent</th><th>Technician</th><th>Status</th><th>Total</th></tr></thead><tbody>';
  rows.forEach(r => html += `<tr><td>${r.phone}</td><td>${r.name}</td><td>${r.location}</td><td>${r.date}</td><td>${r.time}</td><td>${r.agent}</td><td>${r.technician}</td><td>${r.status}</td><td>${r.total}</td></tr>`);
  html += '</tbody></table>';
  document.getElementById('reportDiv').innerHTML = html;
}

function downloadCSV(){
  const table = document.querySelector('#reportDiv table');
  if(!table) return alert('No data to download');
  const rows = Array.from(table.querySelectorAll('tr'));
  const csv = rows.map(row => {
    const cols = Array.from(row.querySelectorAll('th,td')).map(c => `"${c.innerText.replace(/"/g,'""')}"`);
    return cols.join(',');
  }).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'report.csv'; a.click();
}
</script>
</body>
</html>
