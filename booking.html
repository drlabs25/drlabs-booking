<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Booking - Dr. Labs</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: linear-gradient(to bottom right, lightblue, lightgreen);
        margin: 0;
        padding: 20px;
    }
    header {
        display: flex;
        justify-content: space-between;
        background: rgba(255,255,255,0.9);
        padding: 10px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-weight: bold;
    }
    .form-section {
        background: white;
        padding: 15px;
        border-radius: 10px;
        max-width: 900px;
        margin: auto;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    label {
        display: block;
        margin: 8px 0 4px;
        font-weight: bold;
    }
    input, select, textarea, button {
        width: 100%;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 14px;
    }
    button {
        background: #007BFF;
        color: white;
        border: none;
        cursor: pointer;
    }
    button:hover { background: #0056b3; }
    .btn-small {
        width: auto;
        padding: 5px 10px;
        font-size: 12px;
    }
    table {
        width: 100%;
        margin-top: 15px;
        border-collapse: collapse;
    }
    th, td {
        border: 1px solid #ccc;
        padding: 6px;
        text-align: center;
    }
    .status-confirmed { background: lightgreen; }
    .status-cancelled { background: lightcoral; }
    .status-report { background: lightblue; }
</style>
</head>
<body>

<header>
    <div>Agent: <span id="agentName"></span></div>
    <div>Date/Time: <span id="dateTime"></span></div>
    <button onclick="logout()" class="btn-small">Logout</button>
</header>

<div class="form-section">
    <label>Customer Number</label>
    <div style="display:flex; gap:5px;">
        <input type="text" id="custPhone" maxlength="10" placeholder="Enter 10 digit number">
        <button onclick="searchBooking()">Create Booking</button>
    </div>

    <div id="bookingForm" style="display:none; margin-top:20px;">
        <label>Customer Name</label>
        <input type="text" id="custName">

        <label>Date of Birth</label>
        <input type="date" id="dob" onchange="calculateAge()">

        <label>Age</label>
        <input type="number" id="age">

        <label>Gender</label>
        <select id="gender">
            <option value="">Select</option>
            <option>Male</option>
            <option>Female</option>
        </select>

        <label>Address</label>
        <textarea id="address" maxlength="500"></textarea>

        <label>Location</label>
        <input type="text" id="location" maxlength="100">

        <label>City</label>
        <select id="city">
            <option>Chennai</option>
            <option>Bangalore</option>
            <option>Hyderabad</option>
            <option>Mumbai</option>
            <option>Delhi</option>
            <option>Coimbatore</option>
        </select>

        <label>Technician</label>
        <select id="technician"></select>

        <label>Pincode</label>
        <input type="text" id="pincode" maxlength="6">

        <label>Preferred Date</label>
        <input type="date" id="prefDate">

        <label>Preferred Time</label>
        <select id="prefTime"></select>

        <label>Tests</label>
        <select id="tests" multiple></select>

        <label>Packages</label>
        <select id="packages" multiple></select>

        <label>Total Amount</label>
        <input type="number" id="totalAmount" readonly>

        <label>Discount</label>
        <select id="discount"></select>

        <label>Technician Charge</label>
        <input type="number" id="techCharge">

        <label>Total Amount to be Paid</label>
        <input type="number" id="totalPayable" readonly>

        <div style="margin-top:10px; display:flex; gap:5px;">
            <button onclick="submitBooking()">Submit</button>
            <button onclick="branchBooking()">Branch Booking</button>
        </div>
    </div>
</div>

<div class="form-section" id="bookingList" style="display:none;">
    <table>
        <thead>
            <tr>
                <th>Customer Number</th>
                <th>Name</th>
                <th>City</th>
                <th>Technician</th>
                <th>Preferred Date</th>
                <th>Preferred Time</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="bookingsTable"></tbody>
    </table>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxBJHuzAe1EN6npzN-1W6Uc-azhf8-qkm3D6swOqeY3tiNgvXe9wBnA9eI4mPYntS26kw/exec";

document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("agentName").innerText = localStorage.getItem("agentName") || "";
    updateDateTime();
    setInterval(updateDateTime, 1000);
    loadDropdowns();
    setDateLimits();
});

function updateDateTime(){
    document.getElementById("dateTime").innerText = new Date().toLocaleString();
}

function logout(){
    localStorage.clear();
    window.location.href = "agent_login.html";
}

function setDateLimits(){
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("prefDate").setAttribute("min", today);
}

function calculateAge(){
    const dob = document.getElementById("dob").value;
    if(dob){
        const diff = Date.now() - new Date(dob).getTime();
        const age = new Date(diff).getUTCFullYear() - 1970;
        document.getElementById("age").value = age;
    }
}

function loadDropdowns(){
    fetch(WEB_APP_URL + "?action=getTechnicians")
        .then(r=>r.json()).then(data=>{
            let techSel = document.getElementById("technician");
            data.forEach(t=>{
                let opt = document.createElement("option");
                opt.value = t.name;
                opt.textContent = t.name;
                techSel.appendChild(opt);
            });
        });
    fetch(WEB_APP_URL + "?action=getTests")
        .then(r=>r.json()).then(data=>{
            let testSel = document.getElementById("tests");
            data.forEach(t=>{
                let opt = document.createElement("option");
                opt.value = t.name;
                opt.textContent = t.name + " ("+t.cost+")";
                testSel.appendChild(opt);
            });
        });
    fetch(WEB_APP_URL + "?action=getPackages")
        .then(r=>r.json()).then(data=>{
            let pkgSel = document.getElementById("packages");
            data.forEach(p=>{
                let opt = document.createElement("option");
                opt.value = p.name;
                opt.textContent = p.name + " ("+p.cost+")";
                pkgSel.appendChild(opt);
            });
        });
    fetch(WEB_APP_URL + "?action=getDiscounts")
        .then(r=>r.json()).then(data=>{
            let disSel = document.getElementById("discount");
            data.forEach(d=>{
                let opt = document.createElement("option");
                opt.value = d.value;
                opt.textContent = d.value + "%";
                disSel.appendChild(opt);
            });
        });
}

function searchBooking(){
    const phone = document.getElementById("custPhone").value;
    if(phone.length !== 10){
        alert("Enter valid 10 digit number");
        return;
    }
    clearForm();
    fetch(WEB_APP_URL + "?action=getBookingsByPhone&phone="+phone)
        .then(r=>r.json()).then(data=>{
            document.getElementById("bookingForm").style.display = "block";
            if(data.length){
                document.getElementById("bookingList").style.display = "block";
                renderBookings(data);
            } else {
                document.getElementById("bookingList").style.display = "none";
            }
        });
}

function clearForm(){
    document.querySelectorAll("#bookingForm input, #bookingForm select, #bookingForm textarea").forEach(el=>{
        if(el.type!=="button") el.value = "";
    });
}

function renderBookings(data){
    let tbody = document.getElementById("bookingsTable");
    tbody.innerHTML = "";
    data.forEach(b=>{
        let tr = document.createElement("tr");
        tr.className = b.status==="Cancelled" ? "status-cancelled" :
                       b.status==="Report Generated" ? "status-report" : "status-confirmed";
        tr.innerHTML = `
            <td>${b.customerNumber}</td>
            <td>${b.customerName}</td>
            <td>${b.city}</td>
            <td>${b.technician}</td>
            <td>${b.prefDate}</td>
            <td>${b.prefTime}</td>
            <td>${b.status}</td>
            <td>
                <button class="btn-small" onclick="modifyBooking('${b.customerNumber}')">Modify</button>
                <button class="btn-small" onclick="cancelBooking('${b.customerNumber}')">Cancel</button>
                <button class="btn-small" onclick="markReport('${b.customerNumber}')">Report Generated</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function submitBooking(){
    const params = new URLSearchParams({
        action: "createBooking",
        customerNumber: document.getElementById("custPhone").value,
        customerName: document.getElementById("custName").value,
        city: document.getElementById("city").value,
        location: document.getElementById("location").value,
        prefDate: document.getElementById("prefDate").value,
        prefTime: document.getElementById("prefTime").value,
        agentName: localStorage.getItem("agentName"),
        technician: document.getElementById("technician").value,
        totalCost: document.getElementById("totalAmount").value
    });
    fetch(WEB_APP_URL+"?"+params)
        .then(r=>r.json()).then(d=>alert(d.message));
}

function branchBooking(){
    document.getElementById("custName").value="";
    document.getElementById("dob").value="";
    document.getElementById("age").value="";
    document.getElementById("gender").value="";
}

function modifyBooking(phone){
    alert("Modify booking for "+phone);
}

function cancelBooking(phone){
    fetch(WEB_APP_URL+"?action=cancelBooking&phone="+phone)
        .then(r=>r.json()).then(d=>alert(d.message));
}

function markReport(phone){
    fetch(WEB_APP_URL+"?action=markReportGenerated&phone="+phone)
        .then(r=>r.json()).then(d=>alert(d.message));
}
</script>
</body>
</html>
